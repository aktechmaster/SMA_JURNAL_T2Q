<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T2Q Smart Input System</title>
    <link rel="icon" type="image/png" href="logosmpit.png">
    <link rel="shortcut icon" type="image/png" href="logosmpit.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS ASLI ANDA (DIPERTAHANKAN) --- */
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --accent: #0284c7;
            --accent-hover: #0369a1;
            --text-main: #334155;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --input-bg: #f8fafc;
            --success: #10b981;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Ubah ke start agar bisa scroll panjang */
            min-height: 100vh;
            padding: 20px 10px;
        }

        .container {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 550px; /* Sedikit diperlebar */
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05), 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            overflow: hidden;
            position: relative;
            margin-bottom: 80px; /* Space untuk tombol floating */
        }

        .header {
            background: linear-gradient(135deg, #38bdf8 0%, #2563eb 100%);
            padding: 25px;
            text-align: center;
        }

        .header h2 { margin: 0; font-size: 1.4rem; color: white; font-weight: 700; }
        .header p { margin: 5px 0 0; color: rgba(255,255,255,0.9); font-size: 0.85rem; }

        /* --- LOGIKA STYLE BARU UNTUK KARTU SISWA --- */
        .control-area { padding: 20px; background: #fff; border-bottom: 1px solid var(--border); }
        
        .student-list-area {
            padding: 10px 20px 20px 20px;
            background: var(--bg-color);
        }

        /* Kartu Per Siswa */
        .student-card {
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: all 0.2s;
        }
        
        .student-card.active-setor { border-left: 5px solid var(--success); }
        .student-card.absent { border-left: 5px solid var(--danger); opacity: 0.8; }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .student-name { font-weight: 700; color: var(--text-main); font-size: 1.05rem; }

        /* Menggunakan Style Input Anda pada Konteks Lebih Kecil */
        .input-group { margin-bottom: 12px; position: relative; }
        .input-group label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; font-weight: 600; }
        
        .input-wrapper { position: relative; }
        .input-wrapper i {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: var(--text-muted); font-size: 0.9rem; pointer-events: none;
        }

        .mini-input, .mini-select {
            width: 100%;
            padding: 10px 10px 10px 35px; /* Icon space */
            background-color: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            outline: none;
        }
        
        .mini-input:focus, .mini-select:focus {
            border-color: var(--accent);
            background: #fff;
        }

        /* Hidden Sections Animation */
        .hidden-details { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border); }
        .show-details { display: block; animation: slideIn 0.3s forwards; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Floating Submit Button */
        .bottom-action {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; padding: 15px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            display: flex; justify-content: center; z-index: 100;
        }
        
        .btn-submit {
            width: 100%; max-width: 500px;
            padding: 14px;
            background-color: var(--accent);
            color: white; border: none; border-radius: 8px;
            font-weight: 700; font-size: 1rem; cursor: pointer;
            box-shadow: 0 4px 12px rgba(2, 132, 199, 0.2);
            transition: 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-submit:hover { background-color: var(--accent-hover); transform: translateY(-2px); }
        .btn-submit:disabled { background-color: var(--text-muted); cursor: not-allowed; transform: none; }

        /* Badge Styles */
        .badge-tahsin { background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; display: inline-block; margin-bottom: 8px; }
        .badge-tahfidz { background: #ffe4e6; color: #be123c; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; display: inline-block; margin-bottom: 8px; margin-top: 10px;}

        .copyright {
        text-align: center;
        font-size: 11px;
        color: #999;
        margin-top: 30px;
        border-top: 1px solid #eee;
        padding-top: 15px;
        
        /* --- TAMBAHAN PENTING --- */
        padding-bottom: 25px; /* Memberi jarak di bawah tulisan */
        margin-bottom: 5px;   /* Jaga-jaga agar tidak mentok */
        font-family: sans-serif;
      }

    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <img src="logosmpit.png" alt="Logo SMPIT" style="height: 80px; width: auto; margin-bottom: 15px;">
            
            <h2 id="header-title">JURNAL T2Q SMP IT AL-KAUTSAR</h2>
            <p>Smart Input System v2.0</p>
        </div>

        <div class="control-area">
            <div class="input-group">
                <label>Pilih Kelas</label>
                <div class="input-wrapper">
                    <i class="fa-solid fa-school-flag"></i>
                    <select id="kelas" class="mini-select" style="font-weight:bold">
                        <option value="" disabled selected>-- Pilih Kelas --</option>
                        <option value="7">Kelas 7</option>
                        <option value="8">Kelas 8</option>
                        <option value="9">Kelas 9</option>
                    </select>
                </div>
            </div>

            <div class="input-group" style="margin-bottom: 0;">
                <label>Pengampu</label>
                <div class="input-wrapper">
                    <i class="fa-solid fa-chalkboard-user"></i>
                    <select id="pengampu" class="mini-select" disabled>
                        <option>-- Pilih Kelas Dulu --</option>
                    </select>
                </div>
            </div>
            
            <button id="btnLoad" class="btn-submit" style="margin-top: 15px; width:100%; padding: 10px; background: var(--text-main); display:none;">
                <i class="fa-solid fa-users-viewfinder"></i> TAMPILKAN DAFTAR SISWA
            </button>
        </div>

        <form id="bulkForm">
            <div id="student-list-area" class="student-list-area">
                <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                    <i class="fa-solid fa-arrow-up"></i><br>Silakan pilih Kelas & Pengampu diatas.
                </div>
            </div>

            <div class="copyright">
             &copy; 2026 <span>aktechmaster</span> <br> Designed & Developed by aktechmaster
          </div>
            
        </form>
    </div>

    <div class="bottom-action" id="action-bar" style="display:none;">
        <button type="button" class="btn-submit" onclick="submitData()">
            KIRIM DATA (<span id="count-siswa">0</span>) SISWA <i class="fa-solid fa-paper-plane"></i>
        </button>
    </div>

    

<script>
    // --- GANTI URL INI DENGAN HASIL DEPLOY TERBARU ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwi4wU-AyMo5144zyPhNb2YO353BF5GIybtS3Ipwear_CAM9w7umVwp8pkEPPwXJaAFpw/exec"; 

    const elKelas = document.getElementById('kelas');
    const elPengampu = document.getElementById('pengampu');
    const btnLoad = document.getElementById('btnLoad');
    const areaList = document.getElementById('student-list-area');
    const actionBar = document.getElementById('action-bar');
    const countSpan = document.getElementById('count-siswa');

    // 1. GET GURU
    elKelas.addEventListener('change', function() {
        elPengampu.innerHTML = '<option>‚è≥ Loading...</option>';
        elPengampu.disabled = true;
        btnLoad.style.display = 'none';
        
        fetch(`${SCRIPT_URL}?action=getGuru&kelas=${this.value}`)
            .then(res => res.json())
            .then(data => {
                let html = '<option value="" disabled selected>-- Pilih Pengampu --</option>';
                data.forEach(n => html += `<option value="${n}">${n}</option>`);
                elPengampu.innerHTML = html;
                elPengampu.disabled = false;
            });
    });

    // 2. ENABLE LOAD BUTTON
    elPengampu.addEventListener('change', () => {
        btnLoad.style.display = 'block';
    });

    // 3. GET SISWA & GENERATE CARDS (THE MAGIC)
    btnLoad.addEventListener('click', function() {
        const k = elKelas.value;
        const g = elPengampu.value;
        
        areaList.innerHTML = '<div style="text-align:center; padding:30px;"><i class="fa-solid fa-spinner fa-spin fa-2x" style="color:var(--accent)"></i><p>Mengambil Data Siswa...</p></div>';
        
        fetch(`${SCRIPT_URL}?action=getSiswa&kelas=${k}&guru=${encodeURIComponent(g)}`)
            .then(res => res.json())
            .then(siswaList => {
                if(!siswaList || siswaList.length === 0) {
                    areaList.innerHTML = '<div style="text-align:center; color:red">Tidak ada siswa ditemukan.</div>';
                    return;
                }
                renderBulkForm(siswaList);
            });
    });

    // --- FUNGSI RENDER (MEMBUAT TAMPILAN PER SISWA) ---
    function renderBulkForm(list) {
        let html = '';
        list.forEach((nama, i) => {
            // Kita generate ID unik per siswa (idx)
            html += `
            <div class="student-card" id="card-${i}">
                <div class="student-header">
                    <div class="student-name">
                        <i class="fa-solid fa-user-graduate" style="color:var(--accent); margin-right:5px;"></i> ${nama}
                        <input type="hidden" id="nama-${i}" value="${nama}">
                    </div>
                    <div style="width: 110px;">
                        <select id="hadir-${i}" class="mini-select" style="padding: 5px;" onchange="toggleHadir(${i})">
                            <option value="Hadir">‚úÖ Hadir</option>
                            <option value="Sakit">ü§í Sakit</option>
                            <option value="Izin">üì© Izin</option>
                            <option value="Alpha">‚ùå Alpha</option>
                        </select>
                    </div>
                </div>

                <div id="row-setor-${i}" class="input-group">
                    <label style="color:var(--accent)">Status Setoran Hari Ini?</label>
                    <select id="statusSetor-${i}" class="mini-select" style="border-color:var(--accent); font-weight:600;" onchange="toggleSetor(${i})">
                        <option value="Tidak Setor">Tidak Setor</option>
                        <option value="Setor">üéØ YA, SETOR HAFALAN</option>
                    </select>
                </div>

                <div id="details-${i}" class="hidden-details">
                    
                    <div class="badge-tahsin"><i class="fa-solid fa-book-open"></i> PROGRES TAHSIN</div>
                    <div class="input-group">
                        <div class="input-wrapper">
                            <i class="fa-solid fa-bookmark"></i>
                            <input type="text" id="tilawah-${i}" class="mini-input" placeholder="Batas Tilawah (Juz/Hal)...">
                        </div>
                    </div>

                    <div class="badge-tahfidz"><i class="fa-solid fa-quran"></i> PROGRES TAHFIDZ</div>
                    <div class="input-group">
                        <label>Batas Tahfidz (Surat & Ayat)</label>
                        <div class="input-wrapper">
                            <i class="fa-solid fa-pen-nib"></i>
                            <input type="text" id="tahfidz-${i}" class="mini-input" placeholder="Wajib diisi jika setor...">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Target Berikutnya (Opsional)</label>
                        <div class="input-wrapper">
                            <i class="fa-solid fa-award"></i>
                            <input type="text" id="target-${i}" class="mini-input" placeholder="Target besok...">
                        </div>
                    </div>
                </div>
            </div>`;
        });
        
        areaList.innerHTML = html;
        countSpan.innerText = list.length;
        actionBar.style.display = 'flex';
        
        // Auto scroll sedikit kebawah
        window.scrollBy({ top: 200, behavior: 'smooth' });
    }

    // --- LOGIKA CARD (DUPLIKASI LOGIKA LAMA PER BARIS) ---
    window.toggleHadir = (i) => {
        const val = document.getElementById(`hadir-${i}`).value;
        const card = document.getElementById(`card-${i}`);
        const rowSetor = document.getElementById(`row-setor-${i}`);
        const selectSetor = document.getElementById(`statusSetor-${i}`);
        
        if(val !== 'Hadir') {
            card.classList.add('absent');
            rowSetor.style.display = 'none'; // Sembunyikan opsi setor
            selectSetor.value = 'Tidak Setor'; // Reset
            toggleSetor(i); // Trigger hide details
        } else {
            card.classList.remove('absent');
            rowSetor.style.display = 'block';
        }
    };

    window.toggleSetor = (i) => {
        const val = document.getElementById(`statusSetor-${i}`).value;
        const details = document.getElementById(`details-${i}`);
        const card = document.getElementById(`card-${i}`);
        
        if(val === 'Setor') {
            details.classList.add('show-details');
            card.classList.add('active-setor');
        } else {
            details.classList.remove('show-details');
            card.classList.remove('active-setor');
            // Reset fields
            document.getElementById(`tilawah-${i}`).value = '';
            document.getElementById(`tahfidz-${i}`).value = '';
            document.getElementById(`target-${i}`).value = '';
        }
    };

    // --- SUBMIT SEMUA DATA ---
    window.submitData = () => {
        const cards = document.querySelectorAll('.student-card');
        const k = elKelas.value;
        const g = elPengampu.value;
        const btn = document.querySelector('.btn-submit');
        
        let payload = [];
        let errorMsg = null;

        // Loop setiap kartu untuk ambil datanya
        cards.forEach((c, i) => {
            const nama = document.getElementById(`nama-${i}`).value;
            const hadir = document.getElementById(`hadir-${i}`).value;
            const setor = document.getElementById(`statusSetor-${i}`).value;
            
            let dTilawah = "-", dTahfidz = "-", dTarget = "-";

            if (hadir === 'Hadir') {
                // Ambil nilai walau tidak setor (untuk tilawah mungkin diisi walau tidak setor hafalan)
                dTilawah = document.getElementById(`tilawah-${i}`).value;

                if (setor === 'Setor') {
                    dTahfidz = document.getElementById(`tahfidz-${i}`).value;
                    dTarget = document.getElementById(`target-${i}`).value;

                    // VALIDASI: Jika setor, tahfidz wajib isi
                    if (!dTahfidz.trim()) {
                        document.getElementById(`tahfidz-${i}`).style.borderColor = 'red';
                        errorMsg = `Mohon isi Batas Tahfidz untuk siswa: ${nama}`;
                    }
                }
            }

            payload.push({
                kelas: k,
                pengampu: g,
                siswa: nama,
                kehadiran: hadir,
                statusSetor: setor,
                batasTilawah: dTilawah,
                batasTahfidz: dTahfidz,
                target: dTarget
            });
        });

        if(errorMsg) {
            alert("‚ö†Ô∏è " + errorMsg);
            return;
        }

        if(!confirm(`Yakin kirim data untuk ${payload.length} siswa?`)) return;

        // ANIMASI LOADING
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> MENGIRIM...';
        btn.disabled = true;

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(res => {
            if(res.status === 'success') {
                alert("‚úÖ SUKSES! Data tersimpan.");
                window.location.reload();
            } else {
                throw new Error(res.message);
            }
        })
        .catch(err => {
            alert("Gagal: " + err);
            btn.innerHTML = oldText;
            btn.disabled = false;
        });
    };
</script>

</body>
</html>







